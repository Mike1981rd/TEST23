@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<div class="page-header">
	<div class="page-title">
		<h4>@ViewLocalizer["Article List"]</h4>
		<h6>@ViewLocalizer["Manage your Articles"]</h6>
	</div>
	<div class="page-btn">
		<a href="/Inventory/AddArticle" class="btn btn-added"><img src="~/vendor/img/icons/plus.svg" alt="img" class="me-2">@ViewLocalizer["Add Article"]</a>
	</div>
</div>


<!-- /product list -->
<div class="card">
	<div class="card-body">
		<div class="row">

		
		<div class="table-top">
			<div class="search-set">
				<div class="search-path">
					<a class="btn btn-filter" id="filter_search">
						<img src="/vendor/img/icons/filter.svg" alt="img">
						<span><img src="/vendor/img/icons/closes.svg" alt="img"></span>
					</a>
				</div>
				<div class="search-input">
					<a class="btn btn-searchset"><img src="/vendor/img/icons/search-white.svg" alt="img"></a>
					<div class="dataTables_filter"><label> <input id="filter-searchtext" type="search" class="form-control form-control-sm" placeholder="@ViewLocalizer["Search"]..."></label></div>
				</div>
					<div class="search-input" style="margin-left: 30px;">
						<a class="btn btn-searchset"><img src="/vendor/img/icons/scanners.svg" alt="img"></a>
						<div class="dataTables_filter"><label> <input id="filter-barcode" type="search" class="barcode-scanner form-control form-control-sm" placeholder="@ViewLocalizer["Scanning"]..."></label></div>
					</div>
			</div>
			<div class="wordset">
				<ul>
					<li>
						<a data-bs-toggle="tooltip" data-bs-placement="top" title="pdf"><img src="/vendor/img/icons/pdf.svg" alt="img"></a>
					</li>
					<li>
						<a data-bs-toggle="tooltip" data-bs-placement="top" title="excel"><img src="/vendor/img/icons/excel.svg" alt="img"></a>
					</li>
					<li>
						<a data-bs-toggle="tooltip" data-bs-placement="top" title="print"><img src="/vendor/img/icons/printer.svg" alt="img"></a>
					</li>
				</ul>
			</div>
		</div>
		<!-- /Filter -->
		<div class="card" id="filter_inputs">
			<div class="card-body pb-0">
				<div class="row">
					<div class="col-lg col-sm-6 col-12">
						<div class="form-group">
							<label>@ViewLocalizer["Brand"] </label>
							<select id="filter-brand" class="select">
							</select>
						</div>
					</div>
					<div class="col-lg col-sm-6 col-12">
						<div class="form-group">
							<label>@ViewLocalizer["Category"] </label>
							<select id="filter-category" class="select">
								
							</select>
						</div>
					</div>
					<div class="col-lg col-sm-6 col-12">
						<div class="form-group">
							<label>@ViewLocalizer["Sub Category"] </label>
							<select id="filter-subcategory" class="select">
								<option value='' selected>@ViewLocalizer["Choose sub category"]</option>
							</select>
						</div>
					</div>
						<div class="col-lg col-sm-6 col-12">
							<div class="form-group">
								<label>@ViewLocalizer["Supplier"] </label>
								<select id="filter-supplier" class="select">
								</select>
							</div>
						</div>
						<div class="col-lg col-sm-6 col-12">
							<div class="form-group">
								<label>@ViewLocalizer["Status"] </label>
								<select id="filter-status" class="select">
									<option value="1">@ViewLocalizer["Active"]</option>
									<option value="0">@ViewLocalizer["Inactive"]</option>
								</select>
							</div>
						</div>
				</div>
			</div>
		</div>
		<!-- /Filter -->
		<div class="table-responsive">
			<table id="article-list" class="table">
				<thead>
					<tr>
						<th>@ViewLocalizer["Action"]</th>
						<th>@ViewLocalizer["ID"] </th>
						<th>@ViewLocalizer["Photo"] </th>
						<th>@ViewLocalizer["Name"] </th>
						<th>@ViewLocalizer["Brand"]</th>
						<th>@ViewLocalizer["Category"] </th>
						<th>@ViewLocalizer["Sub Category"]</th>						
						<th>@ViewLocalizer["Tax"]</th>
						<th>@ViewLocalizer["Performance (%)"]</th>
						<th>@ViewLocalizer["Minimum"]</th>
						<th>@ViewLocalizer["Maximum"]</th>
						<th>@ViewLocalizer["Status"]</th>
	
					</tr>
				</thead>
			</table>
		</div>
		</div>
	</div>
</div>
<!-- /product list -->





<script>
	let code = "";
	let reading = false;
	document.getElementById("filter-barcode").addEventListener('keypress', e => {
		//usually scanners throw an 'Enter' key at the end of read
		if (e.keyCode === 13) {

			if (code.length >= 8) {
				console.log(code);
				/// code ready to use
				$("#filter-barcode").val(code);
				$("#filter-barcode").change();
				code = "";
			}
		} else {
			code += e.key; //while this is not an 'enter' it stores the every key
		}

		//run a timeout of 200ms at the first read and clear everything
		if (!reading) {
			reading = true;
			setTimeout(() => {
				code = "";
				reading = false;
			}, 200);  //200 works fine for me but you can adjust it
		}
	});
	$(document).ready(function(){
		LoadBrand();
		LoadCategory();
		LoadSupplier();

		$("#filter-searchtext").on("change keyup", function(){
			FilterArticle();
		});
		$("#filter-barode").on("change", function () {
			FilterArticle();
		});
		$("#filter-brand").on("change", function(){
			FilterArticle();
		});
		$("#filter-barcode").on("change", function () {
			FilterArticle();
		});
		$("#filter-supplier").on("change", function () {
			FilterArticle();
		});
		$("#filter-category").on("change", function(){
			FilterArticle();
			LoadSubCategory()
		});
		$("#filter-subcategory").on("change", function () {
			FilterArticle();
		});
		$("#filter-status").on("change", function () {
			FilterArticle();
		});
		$("#filter_search").click(function () {
			if ($(this).hasClass("setclose")) {
				$("#filter-brand").val("").change();
				$("#filter-category").val("").change();
				$("#filter-subcategory").val("").change();
				$("#filter-supplier").val("").change();
			}
		});
	});
	function LoadSupplier() {
		$.ajax({
			url: "/Inventory/GetAllActiveSuppliers",
			type: "POST",
			success: function (data, textStatus, jqXHR) {
				$("#filter-supplier").empty();
				$("#filter-supplier").append("<option value='' selected>@ViewLocalizer["Choose supplier"]</option>")
				for (var i = 0; i < data.length; i++) {
					var d = data[i];
					$("#filter-supplier").append("<option value='" + d.id + "'>" + d.name + "</option>")
				}
				$("#filter-supplier").select2();
			},
			error: function (jqXHR, textStatus, errorThrown) {
				toastr.error("@ViewLocalizer["There was an error in processing the request."]", {})
			}
		});
	}

	function LoadBrand()
	{
		$.ajax({
			url: "/Inventory/GetAllBrands",
            type: "POST",
            success: function (data, textStatus, jqXHR) {
				$("#filter-brand").empty();
				$("#filter-brand").append("<option value='' selected>@ViewLocalizer["Choose brand"]</option>")
				for(var i =0; i < data.length; i++)
				{
					var d = data[i];
					$("#filter-brand").append("<option value='" + d.id + "'>" + d.name + "</option>")
				}
							
				$("#filter-brand").select2();

				var brand = getCookie("prodBrand");
				if (brand && brand !== "")
				{
					$("#filter-brand").val(brand).change();
				}
            },
            error: function (jqXHR, textStatus, errorThrown) {
                toastr.error("@ViewLocalizer["There was an error in processing the request."]", {})
            }
        });
		
	}

	function LoadCategory()
	{
		$.ajax({
			url: "/Menu/GetAllActiveCategoryList",
            type: "POST",
            success: function (data, textStatus, jqXHR) {
				$("#filter-category").empty();
				$("#filter-category").append("<option value='' selected>@ViewLocalizer["Choose category"]</option>")
				for(var i =0; i < data.length; i++)
				{
					var d = data[i];
					$("#filter-category").append("<option value='" + d.id + "'>" + d.name + "</option>")
				}
				$("#filter-category").select2();
				var brand = getCookie("prodCategory");
				if (brand && brand !== "")
				{
					$("#filter-category").val(brand).change();
				}
            },
            error: function (jqXHR, textStatus, errorThrown) {
                toastr.error("@ViewLocalizer["There was an error in processing the request."]", {})
            }
        });
	}

	function LoadSubCategory()
	{
		var category = $("#filter-category").val();
		if (!category) return;
		$.ajax({
			url: "/Menu/GetAllSubCategories?categoryID=" + category,
			type: "POST",
			success: function (data, textStatus, jqXHR) {
				$("#filter-subcategory").empty();
				$("#filter-subcategory").append("<option value='' selected>@ViewLocalizer["Choose sub category"]</option>")
				for (var i = 0; i < data.length; i++) {
					var d = data[i];
					$("#filter-subcategory").append("<option value='" + d.id + "'>" + d.name + "</option>")
				}
				$("#filter-subcategory").select2();

				var brand = getCookie("prodSubCategory");
				if (brand && brand !== "")
				{
					$("#filter-subcategory").val(brand).change();
				}
			},
			error: function (jqXHR, textStatus, errorThrown) {
				toastr.error("@ViewLocalizer["There was an error in processing the request."]", {})
			}
		});
	}

	var articletable = $("#article-list").DataTable({
		"processing": true, // for show progress bar
		"serverSide": true, // for process server side
		"dom": 'rt<"row"<"col-sm-3"l><"col-sm-6 s-txt"p><"col-sm-3 text-end"i>>',
		"orderMulti": false, // for disable multiple column at once
		"ajax": {
			"url": "/Inventory/GetArticleList",
			"type": "POST",
			"datatype": "json",
			"complete": function () {
				$( ".imgzoom" ).each(function() {
					$(this).on( "mouseenter", function() {
						var popupContent = document.createElement("div");
						popupContent.classList.add("popupDiv");
						popupContent.innerHTML = "<img src='" + $(this).attr('src') + "' alt = 'zoomimg' style='height: 450px'> ";

						popupContent.style.position = "absolute";

						popupContent.style.top = ($(this).offset().top + -200)+ "px";
						popupContent.style.left = ($(this).offset().left + 50)+ "px";
						popupContent.style.backgroundColor = "white";
						popupContent.style.padding = "5px";
						popupContent.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.5)";
						popupContent.style.zIndex = "9999";
						popupContent.style.borderRadius = "10px";
						document.body.appendChild(popupContent);

						$(this).on( "mouseleave", function() {
							//document.body.removeChild(popupContent);
							$(".popupDiv").remove();
						});
						
							
					
					});
				});
				
			}
		},
		'select': {
			'style': 'multi'
		},
		"pageLength": 10,
		"lengthMenu": [10, 25, 50],
		"order": [[1, 'asc']],
		"columns": [
				{
				'data': 'action', 'name': 'action',
				render: function (data, type, row) {
					return "<a class='me-3' href='/Inventory/AddArticle?articleId=" + row.id + "' ><img src='/vendor/img/icons/edit.svg' alt='img'></a><a class='me-3' href='javascript:void(0);'  onclick=CopyArticle('" + row.id + "'); ><img src='/vendor/img/icons/copy.png' width='25' alt='img'></a>";
				},
			},
			{ "data": "id", "name": "id", "autoWidth": true },
			{
				'data': 'photo', 'name': 'photo',
				render: function (data, type, row) {
					if (!row.photo) {
						return "<img src='/vendor/img/product/product1.jpg' alt = 'supplier' class='imgzoom'> ";
					}
					else {
						return "<img src='" + row.photo + "' alt = 'supplier' style='max-height:40px; max-width:40px;' class='imgzoom' >";
					}
				},
				"autoWidth": true
			},
			{ "data": "name", "name": "name", "autoWidth": true },
			{ "data": "brand", "name": "brand", "autoWidth": true },
			{ "data": "categoryName", "name": "categoryName", "autoWidth": true },
			{ "data": "subCategoryName", "name": "subCategoryName", "autoWidth": true },			
			{ "data": "tax", "name": "tax", "autoWidth": true },
			{ "data": "performance", "name": "performance", "autoWidth": true },			
			{ "data": "minimumQty", "name": "minimumQty", "autoWidth": true },
			{ "data": "maximumQty", "name": "maximumQty", "autoWidth": true },
			{
				'data': 'status', 'name': 'isActive',
				render: function (data, type, row) {
					if (row.isActive) {
						return "<span class='badges bg-lightgreen'>@ViewLocalizer["Active"]</span>";
					}
					else {
						return "<span class='badges bg-lightred'>@ViewLocalizer["InActive"]</span>";
					}
				},
				"autoWidth": true
			},
		
		]
	});

	function FilterArticle() {
		var searchText = $("#filter-searchtext").val();
		var category = $("#filter-category").val();
		var subcategory = $("#filter-subcategory").val();
		var brand = $("#filter-brand").val();
		var barcode = $("#filter-barcode").val();
		var status = $("#filter-status").val();
		var supplier = $("#filter-supplier").val();

		//if (brand && brand !== "")
			setCookie("prodBrand", brand, 1);
		//if (category && category !== "")
			setCookie("prodCategory", category, 1);
		//if (subcategory && subcategory !== "")
			setCookie("prodSubCategory", subcategory, 1);


		articletable.columns(0).search(searchText);
		articletable.columns(1).search(brand);
		articletable.columns(2).search(category);
		articletable.columns(3).search(subcategory)
		articletable.columns(4).search(barcode)
		articletable.columns(5).search(status)
		articletable.columns(6).search(supplier)

		articletable.draw();
	}


	function CopyArticle(id) {
		Swal.fire({
			title: "@ViewLocalizer["Are you sure to copy the article?"]",
			text: "",
			type: "warning",
			showCancelButton: !0,
			confirmButtonColor: "#3085d6",
			cancelButtonColor: "#d33",
			confirmButtonText: "@ViewLocalizer["Yes"]",
			confirmButtonClass: "btn btn-primary",
			cancelButtonText: "@ViewLocalizer["Close"]",
			cancelButtonClass: "btn btn-danger ml-1",
			buttonsStyling: !1,
		}).then(function (t) {
			if (t.value) {
				$.ajax({
					url: "/Inventory/CopyArticle?articleId=" + id,
					type: "POST",
					contentType: 'application/json;',
					dataType: 'json',
					success: function (data, textStatus, jqXHR) {
						FilterProduct()
					},
					error: function (jqXHR, textStatus, errorThrown) {
						toastr.error("@ViewLocalizer["There was an error in processing the request."]", {})
					}
				});
			}
		});
	}
</script>
